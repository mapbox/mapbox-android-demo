//
// Configuration file for gradle build execution.
//

task clientSecret {
    def secretFile = new File("${projectDir}/src/main/res/values/developer-config.xml")
    if (!secretFile.exists()) {
        String mapboxFlowSecret = "$System.env.MAPBOX_AUTH_FLOW_SECRET"
        if (mapboxFlowSecret == "null") {
            System.out.println("You should set the MAPBOX_AUTH_FLOW_SECRET environment variable.")
            mapboxFlowSecret = "YOUR_MAPBOX_AUTH_FLOW_SECRET_GOES_HERE"
        }

        String segmentWriteKey = "$System.env.SEGMENT_API_WRITE_KEY"
        if (segmentWriteKey == "null") {
            System.out.println("You should set the SEGMENT_API_WRITE_KEY environment variable." +
                    "You will only have potential access to this if you're part of the Mapbox team)")
            segmentWriteKey = "THE_SEGMENT_API_WRITE_KEY_GOES_HERE"
        }
        String tokenFileContents = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" +
                "<resources>\n" +
                "    <string name=\"mapbox_auth_flow_secret\">" + mapboxFlowSecret + "</string>\n" +
                "    <string name=\"mapbox_segment_write_key\">" + segmentWriteKey + "</string>\n" +
                "</resources>"
        secretFile.write(tokenFileContents)
    }
}

task segmentWriteKey {
    String segmentWriteKey = "$System.env.MAPBOX_SEGMENT_WRITE_KEY"
    if (segmentWriteKey == "null") {
        System.out.println("You should set the MAPBOX_SEGMENT_WRITE_KEY environment variable.")
        segmentWriteKey = "MAPBOX_DEMO_SEGMENT_WRITE_KEY"
    }
}

gradle.projectsEvaluated {
    preBuild.dependsOn('clientSecret')
    preBuild.dependsOn('segmentWriteKey')
}